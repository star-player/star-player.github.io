<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¼€ì´ìŠ¤ ì •ë¦¬ ë„êµ¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    nav { background: #333; color: white; padding: 10px; display: flex; gap: 15px; }
    nav a { color: white; text-decoration: none; cursor: pointer; }
    .page { display: none; padding: 20px; }
    .active { display: block; }
    textarea { width: 100%; height: 200px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th:nth-child(n+2), td:nth-child(n+2) { text-align: center; }
    thead th { background-color: #f0f0f0; }
    .highlight { background-color: #fff8b3; cursor: help; }
    button { margin: 5px 0; padding: 8px 12px; width: 220px; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shortcut-container { display: flex; gap: 0; }
    .shortcut-group { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; padding: 0 10px; }
    .divider { width: 2px; background: #ccc; }
  </style>
</head>
<body>

<nav>
  <a onclick="showPage('parser')">ë°ì´í„° ì •ë¦¬</a>
  <a onclick="showPage('shortcuts')">ë°”ë¡œê°€ê¸°</a>
</nav>

<div id="parser" class="page active">
  <h2>ğŸ“‹ ë°ì´í„° ì •ë¦¬</h2>
  <textarea id="rawText" placeholder="ì—¬ê¸°ì— ì¼€ì´ìŠ¤ ë³µë¶™í•˜ì„¸ìš”..."></textarea><br>
  <button onclick="processText()">ì •ë¦¬í•˜ê¸°</button>
  <button onclick="downloadExcel()">ì—‘ì…€ë¡œ ì €ì¥</button>

  <table id="resultTable">
    <thead>
      <tr>
        <th>ì¼€ì´ìŠ¤ ì œëª©</th>
        <th>ìš”ì²­ ID</th>
        <th>ì‹¬ê°ë„</th>
        <th>ë§Œë“  ë‚ ì§œ</th>
        <th>Age</th>
        <th>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</th>
        <th>ì œí’ˆ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="shortcuts" class="page">
  <h2>ğŸš€ ë°”ë¡œê°€ê¸°</h2>
  <div class="shortcut-container">
    <div class="shortcut-group">
      <button onclick="window.open('https://engagehub.microsoft.com/#view/Microsoft_AzureCXP_EngageHub/EngageHubMenuBlade/~/selfHelp', '_blank')">
        On-premises ì¼€ì´ìŠ¤ ë§Œë“¤ê¸°
      </button>
      <button onclick="window.open('https://portal.azure.com/', '_blank')">
        Azure Portal
      </button>
      <button onclick="window.open('https://lynx.office.net/incidents', '_blank')">
        LYNX Incident í™•ì¸
      </button>
    </div>
    <div class="divider"></div>
    <div class="shortcut-group">
      <button onclick="window.open('https://b2b.officedepot.co.kr/htm/main/main_main.asp', '_blank')">
        ëª…í•¨ ì‹ ì²­
      </button>
      <button onclick="window.open('https://microsoftapc.sharepoint.com/teams/REFKoreaSR/SitePages/Parking-%EC%95%88%EB%82%B4.aspx?csf=1&web=1&share=EaPaaa-SHnNEmsom_RToX38BSQdARwoH2LvvD06KEgsxHw&e=e5l1KK&CID=8172409e-1e7b-44ce-a85e-dd55314d3d27', '_blank')">
        ì£¼ì°¨ ì‹ ì²­
      </button>
    </div>
  </div>
</div>

<script>
  const caseList = [];

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function processText() {
    const text = document.getElementById("rawText").value;
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = '';
    caseList.length = 0;

    let current = {};
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      if (line.endsWith('î¢§')) {
        if (current.title) {
          caseList.push(current);
          addRow(current);
          current = {};
        }
        current.title = line.replace('î¢§', '').trim();
      } else if (line.startsWith('ìš”ì²­ ID:') && lines[i + 1]) {
        current.id = lines[i + 1].trim();
      } else if (line.startsWith('ì‹¬ê°ë„:') && lines[i + 1]) {
        current.severity = lines[i + 1].trim().charAt(0);
      } else if (line.startsWith('ë§Œë“  ë‚ ì§œ:') && lines[i + 1]) {
        const rawDate = lines[i + 1].trim();
        const formatted = parseKoreanDate(rawDate);
        current.date = formatted.display;
        current.age = formatted.age;
      } else if (line.startsWith('ì œí’ˆ:') && lines[i + 1]) {
        current.product = lines[i + 1].trim();
      } else if (line === 'ì—´ê¸°' && lines[i - 1]) {
        const updatedRaw = lines[i - 1].trim();
        const formatted = parseKoreanDate(updatedRaw);
        current.lastUpdated = formatted.display;
        current.lastUpdatedDays = formatted.diffDays;
      }
    }
    if (current.title) {
      caseList.push(current);
      addRow(current);
    }
  }

  function parseKoreanDate(koreanDateStr) {
    const regex = /(\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼ .* (ì˜¤ì „|ì˜¤í›„) (\d{1,2}):(\d{2})/;
    const match = koreanDateStr.match(regex);
    if (!match) return { display: '', age: '', diffDays: null };

    let [ , year, month, day, ampm, hour, minute ] = match;
    hour = parseInt(hour);
    if (ampm === 'ì˜¤í›„' && hour !== 12) hour += 12;
    if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0;

    const date = new Date(`${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${hour.toString().padStart(2, '0')}:${minute}`);
    const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const weekday = weekdays[date.getDay()];
    const today = new Date();
    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
    const display = `${year}/${month.padStart(2, '0')}/${day.padStart(2, '0')} ${hour.toString().padStart(2, '0')}:${minute}(${weekday})`;

    return { display, age: `${diffDays}ì¼`, diffDays };
  }

  function addRow(data) {
    const row = document.createElement("tr");
    const lastUpdatedClass = data.lastUpdatedDays >= 5 ? 'highlight' : '';
    const tooltip = data.lastUpdatedDays >= 5 ? `title="${data.lastUpdatedDays}ì¼ ê²½ê³¼"` : '';
    row.innerHTML = `
      <td>${data.title}</td>
      <td>${data.id || ''}</td>
      <td>${data.severity || ''}</td>
      <td>${data.date || ''}</td>
      <td>${data.age || ''}</td>
      <td class="${lastUpdatedClass}" ${tooltip}>${data.lastUpdated || ''}</td>
      <td>${data.product || ''}</td>
    `;
    document.querySelector("#resultTable tbody").appendChild(row);
  }

  function downloadExcel() {
    const wb = XLSX.utils.book_new();
    const ws_data = [
      ["ì¼€ì´ìŠ¤ ì œëª©", "ìš”ì²­ ID", "ì‹¬ê°ë„", "ë§Œë“  ë‚ ì§œ", "Age", "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸", "ì œí’ˆ"],
      ...caseList.map(c => [c.title, c.id, c.severity, c.date, c.age, c.lastUpdated, c.product])
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Cases");
    XLSX.writeFile(wb, "cases.xlsx");
  }
</script>
</body>
</html>
